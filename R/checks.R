#' Check for API User Privilege Issues
#'
#' Check for potential user access privilege issues and provide an appropriate warning message. This can occur when metadata forms/field names do not appear in a database export.
#'
#' @importFrom rlang .data
#'
#' @param db_data The REDCap database output generated by \code{REDCapR::redcap_read_oneshot()$data}
#' @param db_metadata The REDCap metadata output generated by \code{REDCapR::redcap_metadata_read()$data}
#'
#' @export
#' @keywords internal

check_user_rights <- function(
    db_data,
    db_metadata
) {
  # Similar to link_arms, use pivot wider to create list elements with top
  # level form_name and vector of associated field_names
  missing_db_metadata <- db_metadata %>%
    filter(!.data$field_name_updated %in% names(db_data)) %>%
    select(.data$field_name_updated, .data$form_name) %>%
    pivot_wider(names_from = .data$form_name,
                values_from = .data$field_name_updated,
                values_fn = list)

  # Supply user with warning message(s) displaying missing form name and
  # associated fields
  for (i in 1:ncol(missing_db_metadata)) {
    warning(paste0("Form name {", names(missing_db_metadata)[i], "} detected in metadata but not found in the database export. Check your user API privileges. The following variables have been removed from the output: ", paste(unlist(missing_db_metadata[i][[1]]),  collapse = ", ")), call. = FALSE)
  }
}
