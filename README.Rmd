---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

# REDCapTidieR

<p align="center">

<img src="man/figures/REDCapTidieR.png" alt="drawing" width="150" align="right"/>

</p>

<!-- badges: start -->

[![Lifecycle: experimental](https://img.shields.io/badge/lifecycle-experimental-orange.svg)](https://lifecycle.r-lib.org/articles/stages.html#experimental) [![R-CMD-check](https://github.com/CHOP-CGTDataOps/REDCapTidieR/actions/workflows/R-CMD-check.yaml/badge.svg)](https://github.com/CHOP-CGTDataOps/REDCapTidieR/actions/workflows/R-CMD-check.yaml)

<!-- badges: end -->

[REDCap](https://www.project-redcap.org/) is a powerful database solution used by many research institutions:

> "REDCap is a secure web application for building and managing online surveys and databases. While REDCap can be used to collect virtually any type of data in any environment (including compliance with 21 CFR Part 11, FISMA, HIPAA, and GDPR), it is specifically geared to support online and offline data capture for research studies and operations."

The [`REDCapR`](https://ouhscbbmc.github.io/REDCapR/) package streamlines calls to the REDCap API. A common use for `REDCapR` is to download records from a REDCap project and present it to the analyst as a data frame. This works well for simple projects, however becomes ugly when complex databases that include a longitudinal structure and/or repeated instruments are involved.

The aim of `REDCapTidieR` is to make the life of analysts who deal with these complex databases easier. It does so by building upon `REDCapR` to make its output tidier. Instead of one large data frame, the analyst gets to work with a set of tidy tibbles, one for each REDCap instrument.

## Installation

You can install the development version of `REDCapTidieR` like so:

```{r, eval = FALSE}
devtools::install_github("CHOP-CGTDataOps/REDCapTidieR")
```

## Getting started

```{r}
library(REDCapTidieR)
library(magrittr)
```

The two main functions of `REDCapTidieR` are `read_redcap_tidy()` and `bind_tables()`. Here is how they can be used together to import all data from a REDCap project and add a set of tidy tibbles in the global environment:

```{r, eval = FALSE}
read_redcap_tidy(redcap_uri, token) %>% 
  bind_tables()
```

## Details

### Structure of the tibble returned by `read_redcap_tidy`

The `read_redcap_tidy` function returns a tibble in which each row represents a REDCap instrument. The first column (`redcap_form_name`) contains the instrument name. The second column (`redcap_data`) is a [**list column**](https://www.rstudio.com/resources/webinars/how-to-work-with-list-columns/) containing a tibble for each instrument.

```{r, include = FALSE}
token <- Sys.getenv("REDCAPTIDIER_SUPERHEROES_API")
redcap_uri <- Sys.getenv("REDCAP_URI")
```

```{r, message = FALSE}
superheroes_data <- read_redcap_tidy(redcap_uri, token)

superheroes_data
```

In the above example, you can see that there is data from two instruments, `super_hero_powers` and `heroes_information`. From the `structure` column, you can see that the `super_hero_powers` instrument is *repeating* and the `heroes_information` instrument is *nonrepeating*.

Let's take a look at `heroes_information`:

```{r}
heroes_information <- superheroes_data$redcap_data[[2]]

heroes_information
```

### Binding `REDCapTidieR` tibbles into an environment

Above, we manually extracted the `heroes_information` tibble from the output of `read_redcap_tidy()`. This approach can become tedious when the REDCap project has lots of instruments, and there are many tibbles to extract.

The `bind_tables()` function takes the output of `read_redcap_tidy()`, extracts the individual tibbles, and binds them to an [environment](http://adv-r.had.co.nz/Environments.html). By default, this is the global environment:

```{r, include = FALSE, warning = FALSE}
rm(redcap_uri, token, heroes_information)
```

```{r}
ls.str(envir = globalenv())
```

```{r}
superheroes_data %>%
  bind_tables()
```

```{r}
ls.str(envir = globalenv())
```

Note that there are now two additional tibbles in the environment.

## Getting help

If you encounter a bug, please file a minimal reproducible example on [github](https://github.com/CHOP-CGTDataOps/REDCapTidieR/issues). For questions and other discussion, please feel free to reach out to the authors by email.
