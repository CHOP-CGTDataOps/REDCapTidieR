---
title: "Exporting to XLSX"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Exporting to XLSX}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r, include = FALSE}
library(httptest)
# Make sure REDCapTidieR is loaded so httptest can find redact.R
library(REDCapTidieR)

# Use fake credentials if mocks exist, otherwise use real credentials to create mocks
fake <- dir.exists("export_to_xlsx")

creds <- REDCapTidieR:::get_credentials(
  c("REDCAP_URI", "SUPERHEROES_REDCAP_API", "REDCAPTIDIER_CLASSIC_API"),
  fake = fake
)

redcap_uri <- creds$REDCAP_URI
superheroes_token <- creds$SUPERHEROES_REDCAP_API
classic_token <- creds$REDCAPTIDIER_CLASSIC_API

start_vignette("export_to_xlsx")
```

## Exporting REDCap Data to XLSX

Excel spreadsheets offer an accessible medium for data analysis and collaboration. In this section, we will be discussing how to turn your REDCap data into a XLSX document that can be easily shared with others using REDCapTidieR.

Converting your data into a XLSX output can be achieved in 3 simple steps using the `write_redcap_xlsx()` function:

1) Define your REDCap URI and API token
2) Call `read_redcap()`
3) Call `write_redcap_xlsx()`

In practice, this looks like:

```{r, eval=FALSE}
redcap_uri <- "https://my.institution.edu/redcap/api/"
token <- "123456789ABCDEF123456789ABCDEF04"

supertbl <- read_redcap(redcap_uri, token)
write_redcap_xlsx(supertbl, file = "my_redcap_data.xlsx")
```

The output file will contain the data corresponding to each REDCap [instrument](glossary.html#instrument) in its own sheet along with two helper sheets called "Table of Contents" and "REDCap Metadata."

<center>

![Sample output](images/write_xlsx_heroes_information.png)

</center>

## Under the Hood and Additional Options

`write_redcap_xlsx()` is built by leveraging the powerful [`openxlsx2`](https://janmarvin.github.io/openxlsx2/) package. To demonstrate more of its capabilities, we will be using the superheroes dataset from the case study in the [Getting Started](REDCapTidieR.html#case-study-the-superhero-database) vignette. Let's start by looking at the data:

``` r
superheroes_token <- "123456789ABCDEF123456789ABCDEF04"
redcap_uri <- "https://my.institution.edu/redcap/api/"
```

```{r}
supertbl <- read_redcap(redcap_uri, superheroes_token)

supertbl %>%
  rmarkdown::paged_table()
```

The goal of `write_redcap_xlsx()` is to provide a single `.xlsx` file where each [data tibble](glossary.html#data-tibble) (i.e., what is listed under the `redcap_data` column) is displayed in its own sheet. Let's try it with the superheroes `supertbl` created above:

```{r, eval=FALSE}
supertbl %>%
  write_redcap_xlsx(file = "supertbl.xlsx")
```

<center>

![Default output using write_redcap_xlsx](images/write_xlsx_default.png)

</center>

### Sheet Structure

You may notice two unexpected sheets appear. The "Table of Contents" and "REDCap Metadata" sheets are provided by default to assist users in navigating their export contents. Both are optional and can be hidden via their corresponding function arguments `include_toc_sheet` and `include_metadata_sheet`. 

The "Table of Contents" sheet provides summary data representing key elements from the [supertibble](glossary.html#supertibble) along with the numeric sheet location of the corresponding `redcap_data`/[data tibble](glossary.html#data-tibble) in the XLSX file (see column H titled "Sheet" in the image above).

The "REDCap Metadata" sheet provides a consolidated view of the `redcap_metadata`/[metadata tibbles](glossary.html#metadata-tibble) from the [supertibble](glossary.html#supertibble):

<center>

![Metadata sheet using write_redcap_xlsx](images/write_xlsx_metadata.png)

</center>

In between these sheets, you can find the expected [data tibbles](glossary.html#data-tibble). Below, observe the expected contents of the "Heroes Information" [data tibble](glossary.html#data-tibble):

<center>

![Heroes Information sheet](images/write_xlsx_heroes_information.png)

</center>

### Making Your XLSX Labelled

`write_redcap_xlsx()` also supports application of labels via `make_labelled()`. Labels can be applied to both the column names in sheets and to the names of the sheets themselves. By default, `write_redcap_xlsx()` will attempt to detect the presence of labels and apply them accordingly, but you can specify whether or not you want them using the appropriate function arguments `add_labelled_column_headers` and `use_labels_for_sheet_names`. If labels are applied to the [data tibbles](glossary.html#data-tibble), then tables will shift down one row and the first row will be dedicated to the labels.

You can learn more about label application to your [supertibble](glossary.html#supertibble) data in the [Getting Started](REDCapTidieR.html#adding-variable-labels-with-the-labelled-package) vignette.

Applying labels to an output looks like:

```{r, eval=FALSE}
supertbl %>%
   make_labelled() %>%
   write_redcap_xlsx("supertbl.xlsx")
```

<center>

![Labelled supertbl output](images/write_xlsx_supertbl_labelled.png)

</center>

Notice how row 1 now contains labels associated with each column.

### Logical Recoding

By default, `write_redcap_xlsx()` recodes logical values to ones that are easier to decipher using the `recode_logical` argument:

```{r, eval = FALSE}
supertbl %>%
  write_redcap_xlsx(recode_logical = TRUE)
```

Using the default (`TRUE`), results in the following changes:

- "yesno" fields are recoded from `TRUE`/`FALSE` to `yes`/`no`
- "checkbox" fields are recoded from `TRUE`/`FALSE` to `Checked`/`Unchecked`
- "truefalse" fields are left as is (`TRUE`/`FALSE`)

```{r, include=FALSE}
end_vignette()
```
